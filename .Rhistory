# colour palettes
fg_cols <- c(
"Grazer" = "#66c2a4",
"Invertivore" = "#41b6c4",
"Mesopredator" = "#2c7fb8",
"HTLP" = "#253494"
)
reef_cols <- c("Natural" = "#66BFA6", "Artificial" = "#007A87")
library(ggeffects)
library(dplyr)
library(ggplot2)
mid_date <- median(fish_long_life$date_num, na.rm = TRUE)
p_main <- ggpredict(
m_stage,
terms     = c("life_stage", "Type"),
condition = c(
Inclusion_m = 5,          # predict per 5 m of transect
date_num    = mid_date    # fix time at a typical date
)
) %>%
as.data.frame() %>%
rename(
life_stage = x,
reef_type  = group
) %>%
mutate(
life_stage = factor(life_stage,
levels = c("juvenile", "mixed", "adult"))
)
ggplot(p_main,
aes(x = life_stage, y = predicted, color = reef_type)) +
geom_point(size = 3,
position = position_dodge(width = 0.4)) +
geom_errorbar(
aes(ymin = conf.low, ymax = conf.high),
width = 0.2,
position = position_dodge(width = 0.4)
) +
scale_color_manual(values = reef_cols, name = "Reef type") +
labs(
x = "Life stage",
y = "Predicted count per 5 m"
) +
theme_clean
p_pair <- ggpredict(
m_stage,
terms     = c("life_stage", "Type", "Pair"),
condition = c(
Inclusion_m = 5,
date_num    = mid_date
)
) %>%
as.data.frame() %>%
rename(
life_stage = x,
reef_type  = group
) %>%
mutate(
life_stage = factor(life_stage,
levels = c("juvenile", "mixed", "adult"))
)
ggplot(p_pair,
aes(x = life_stage, y = predicted, color = reef_type,
group = interaction(reef_type, facet))) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~ facet, labeller = labeller(facet = label_both)) +
scale_color_manual(values = reef_cols, name = "Reef type") +
labs(
x = "Life stage",
y = "Predicted count per 5 m"
) +
theme_clean
p_pair
m_stage <- glmmTMB(
Count ~ Type * life_stage +
date_num + pair +
Count.Type +
offset(log(Inclusion_m)) +
(1 |  Site) +
(1 | survey_id),
family = nbinom2,
data   = fish_long_life
)
summary(m_stage)
m_stage_fx <- glmmTMB(
Count ~ Type * life_stage * Pair +
date_num +
Count.Type +
offset(log(Inclusion_m)) +
(1 | Site) +            # random site within pair is fine
(1 | survey_id),
family = nbinom2,
data   = fish_long_life
)
# with pair as an interaction
m_stage_fx <- glmmTMB(
Count ~ Type * life_stage * Pair +
date_num +
Count.Type +
offset(log(Inclusion_m)) +
(1 | Site) +            # random site within pair is fine
(1 | survey_id),
family = nbinom2,
data   = fish_long_life
)
summary(m_stage_fx)
summary(m_stage)
### pair specific predictions
p_pair <- ggpredict(
m_stage_fx,
terms = c("life_stage", "Type", "Pair"),
condition = c(Inclusion_m = 5)    # 5 m transect length
) %>%
as.data.frame() %>%
ggplot(aes(x = x, y = predicted, color = group)) +
geom_point() +
geom_line(aes(group = group)) +
facet_wrap(~ facet) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(x = "Life stage", y = "Predicted count per 5 m")
ggplot(p_pair,
aes(x = life_stage, y = predicted, color = reef_type,
group = interaction(reef_type, facet))) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~ facet, labeller = labeller(facet = label_both)) +
scale_color_manual(values = reef_cols, name = "Reef type") +
labs(
x = "Life stage",
y = "Predicted count per 5 m"
) +
theme_clean
### pair specific predictions
p_pair <- ggpredict(
m_stage_fx,
terms = c("life_stage", "Type", "Pair"),
condition = c(Inclusion_m = 5)    # 5 m transect length
) %>%
as.data.frame() %>%
ggplot(aes(x = x, y = predicted, color = group)) +
geom_point() +
geom_line(aes(group = group)) +
facet_wrap(~ facet) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(x = "Life stage", y = "Predicted count per 5 m")
### pair specific predictions
p_pair <- ggpredict(
m_stage_fx,
terms = c("life_stage", "Type", "Pair"),
condition = c(Inclusion_m = 5)    # 5 m transect length
) %>%
as.data.frame() %>%
ggplot(aes(x = x, y = predicted, color = group)) +
geom_point() +
geom_line(aes(group = group)) +
facet_wrap(~ facet) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(x = "Life stage", y = "Predicted count per 5 m")
### pair specific predictions
p_pair <- ggpredict(
m_stage_fx,
terms = c("life_stage", "Type", "Pair"),
condition = c(Inclusion_m = 5)    # 5 m transect length
) %>%
as.data.frame() %>%
ggplot(aes(x = x, y = predicted, color = group)) +
geom_point() +
geom_line(aes(group = group)) +
facet_wrap(~ facet) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(x = "Life stage", y = "Predicted count per 5 m")
p_pair
# set levels in order
fish_long_life <- fish_long_life %>%
mutate(
life_stage = factor(
life_stage,
levels = c("juvenile", "mixed", "adult")
)
)
# the actual model #####
m_stage <- glmmTMB(
Count ~ Type * life_stage +
date_num + pair +
Count.Type +
offset(log(Inclusion_m)) +
(1 |  Site) +
(1 | survey_id),
family = nbinom2,
data   = fish_long_life
)
summary(m_stage)
# with pair as an interaction
m_stage_fx <- glmmTMB(
Count ~ Type * life_stage * Pair +
date_num +
Count.Type +
offset(log(Inclusion_m)) +
(1 | Site) +            # random site within pair is fine
(1 | survey_id),
family = nbinom2,
data   = fish_long_life
)
summary(m_stage_fx)
pred_stage <- ggpredict(
m_stage_fx,
terms = c("life_stage", "Type", "Pair"),
condition = c(Inclusion_m = 5)
) %>%
as.data.frame()
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point() +
geom_line(aes(group = group)) +
facet_wrap(~ facet) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(x = "Life stage", y = "Predicted count per 5 m")
p_pair
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(size = 2, position = position_dodge(width = 0.4)) +
# 95% CI error bars
geom_errorbar(
aes(ymin = conf.low, ymax = conf.high),
width = 0.2,
alpha = 0.5,
position = position_dodge(width = 0.4)
) +
# Ribbon for smoother visual CI (optional)
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group),
color = NA,
alpha = 0.12,
position = position_dodge(width = 0.4)
) +
facet_wrap(~ facet, nrow = 1) +           # each Pair
scale_color_manual(values = reef_cols) +
scale_fill_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type",
fill  = "Reef type"
)
p_pair
pred_stage$x <- factor(
pred_stage$x,
levels = c("juvenile", "mixed", "adult"),
ordered = TRUE
)
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(size = 2, position = position_dodge(width = 0.4)) +
# 95% CI error bars
geom_errorbar(
aes(ymin = conf.low, ymax = conf.high),
width = 0.2,
alpha = 0.5,
position = position_dodge(width = 0.4)
) +
# Ribbon for smoother visual CI (optional)
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group),
color = NA,
alpha = 0.12,
position = position_dodge(width = 0.4)
) +
facet_wrap(~ facet, nrow = 1) +           # each Pair
scale_color_manual(values = reef_cols) +
scale_fill_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type",
fill  = "Reef type"
)
p_pair
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(
size = 2.4,
position = position_dodge(width = 0.5)
) +
geom_errorbar(
aes(ymin = conf.low,
ymax = conf.high,
color = group),     # <- IMPORTANT
width = 0.15,
position = position_dodge(width = 0.5),
linewidth = 0.4        # <- visible on small values
) +
facet_wrap(~ facet, nrow = 1) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type"
)
p_pair
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(
size = 2.4,
position = position_dodge(width = 0.5)
) +
geom_errorbar(
aes(ymin = conf.low,
ymax = conf.high,
color = group),     # <- IMPORTANT
width = 0.15,
position = position_dodge(width = 0.5),
linewidth = 0.4        # <- visible on small values
) +
# Ribbon for smoother visual CI (optional)
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group),
color = NA,
alpha = 0.12,
position = position_dodge(width = 0.4)
) +
facet_wrap(~ facet, nrow = 1) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type"
)
p_pair
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(
size = 2.4,
position = position_dodge(width = 0.5)
) +
geom_errorbar(
aes(ymin = conf.low,
ymax = conf.high,
color = group),     # <- IMPORTANT
width = 0.15,
position = position_dodge(width = 0.5),
linewidth = 0.4        # <- visible on small values
) +
# Ribbon for smoother visual CI (optional)
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group),
color = reef_cols,
alpha = 0.12,
position = position_dodge(width = 0.4)
) +
facet_wrap(~ facet, nrow = 1) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type"
)
p_pair
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(
size = 2.4,
position = position_dodge(width = 0.5)
) +
geom_errorbar(
aes(ymin = conf.low,
ymax = conf.high,
color = group),     # <- IMPORTANT
width = 0.15,
position = position_dodge(width = 0.5),
linewidth = 0.4        # <- visible on small values
) +
# Ribbon for smoother visual CI (optional)
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group),
color = "gray",
alpha = 0.12,
position = position_dodge(width = 0.4)
) +
facet_wrap(~ facet, nrow = 1) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type"
)
p_pair
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(
size = 2.4,
position = position_dodge(width = 0.5)
) +
geom_errorbar(
aes(ymin = conf.low,
ymax = conf.high,
color = group),     # <- IMPORTANT
width = 0.15,
position = position_dodge(width = 0.5),
linewidth = 0.4        # <- visible on small values
) +
# Ribbon for smoother visual CI (optional)
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group),
color = "gray",
alpha = 0.9,
position = position_dodge(width = 0.4)
) +
facet_wrap(~ facet, nrow = 1) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type"
)
p_pair
pred_stage <- ggpredict(
m_stage_fx,
terms = c("life_stage", "Type", "Pair"),
condition = c(Inclusion_m = 5)
) %>%
as.data.frame()
pred_stage$x <- factor(
pred_stage$x,
levels = c("juvenile", "mixed", "adult"),
ordered = TRUE
)
pred_stage <- pred_stage %>%
mutate(
x_fac = factor(x, levels = c("juvenile","mixed","adult")),
x_num = as.numeric(x_fac)
)
p_pair <- ggplot(pred_stage, aes(x = x_num, y = predicted, color = group)) +
geom_point(position = position_dodge(width = 0.4)) +
geom_errorbar(
aes(ymin = conf.low, ymax = conf.high),
position = position_dodge(width = 0.4),
width = 0.15
) +
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group, group = interaction(group, x_fac)),
alpha = 0.1,
color = NA
) +
scale_x_continuous(
breaks = c(1,2,3),
labels = c("juvenile","mixed","adult")
)
p_pair
p_pair <- ggplot(pred_stage, aes(x = x_num, y = predicted, color = group)) +
geom_point(position = position_dodge(width = 0.4)) +
geom_errorbar(
aes(ymin = conf.low, ymax = conf.high),
position = position_dodge(width = 0.4),
width = 0.15
) +
geom_ribbon(
aes(ymin = conf.low, ymax = conf.high, fill = group, group = interaction(group, x_fac)),
alpha = 0.1,
color = NA
) +
scale_x_continuous(
breaks = c(1,2,3),
labels = c("juvenile","mixed","adult")
) + theme_clean
p_pair
pred_stage <- ggpredict(
m_stage_fx,
terms = c("life_stage", "Type", "Pair"),
condition = c(Inclusion_m = 5)
) %>%
as.data.frame()
pred_stage$x <- factor(
pred_stage$x,
levels = c("juvenile", "mixed", "adult"),
ordered = TRUE
)
p_pair <- ggplot(pred_stage,
aes(x = x, y = predicted, color = group)) +
geom_point(
size = 2.4,
position = position_dodge(width = 0.5)
) +
geom_errorbar(
aes(ymin = conf.low,
ymax = conf.high,
color = group),     # <- IMPORTANT
width = 0.15,
position = position_dodge(width = 0.5),
linewidth = 0.4        # <- visible on small values
) +
facet_wrap(~ facet, nrow = 1) +
scale_color_manual(values = reef_cols) +
theme_clean +
labs(
x = "Life stage",
y = "Predicted count per 5 m",
color = "Reef type"
)
p_pair
